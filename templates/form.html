{% extends "base.html" %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <h1 style="text-align: center; margin-bottom: 25px; color: #2c3e50;">–§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏ —Å —Ä–∞—Å—á–µ—Ç–æ–º</h1>

    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); margin-bottom: 30px;">
        <p style="text-align: center; margin-bottom: 25px; color: #666; font-size: 1.05rem;">
            –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—è–≤–∫–∏.
        </p>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—á–µ—Ç–µ -->
        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #3498db;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 1.2rem;">üí∞</span>
                <div>
                    <strong style="color: #2c3e50;">–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</strong>
                    <p style="margin: 5px 0 0; color: #666; font-size: 0.9rem;">
                        –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç –∏ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                    </p>
                </div>
            </div>
        </div>

        <form method="POST" action="{{ url_for('main.submit_application') }}" id="applicationForm" style="margin-bottom: 20px;">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.2rem;">üë§ –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>

                <div style="margin-bottom: 20px;">
                    <label for="full_name" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                        –§–ò–û *
                    </label>
                    <input type="text" id="full_name" name="full_name" required
                           placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                           style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="address" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                        –ê–¥—Ä–µ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç *
                    </label>
                    <input type="text" id="address" name="address" required
                           placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 1, –∫–≤. 1"
                           style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="phone" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                        –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ *
                    </label>
                    <input type="tel" id="phone" name="phone" required
                           placeholder="+7 (999) 123-45-67"
                           style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                </div>
            </div>

            <!-- –í—ã–±–æ—Ä —Ä–∞–±–æ—Ç -->
            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                <h3 style="color: #2c3e50; margin-bottom: 20px; font-size: 1.2rem;">üîß –í—ã–±–æ—Ä —Ä–∞–±–æ—Ç *</h3>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –≤–∏–¥ —Ä–∞–±–æ—Ç
                </p>

                <!-- –°–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç -->
                <div id="worksList" style="margin-bottom: 20px;">
                    <!-- –†–∞–±–æ—Ç–∞ 1 -->
                    <div class="work-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h4 style="color: #2c3e50; margin: 0; font-size: 1.1rem;">–†–µ–º–æ–Ω—Ç –ø–æ–º–µ—â–µ–Ω–∏–π</h4>
                                <p style="color: #666; margin: 5px 0; font-size: 0.9rem;">–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π/–∫–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</p>
                                <p style="color: #e74c3c; font-weight: 600; margin: 0;">3 000 ‚ÇΩ –∑–∞ –º¬≤</p>
                            </div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="work_type" value="–†–µ–º–æ–Ω—Ç –ø–æ–º–µ—â–µ–Ω–∏–π" data-price="3000" data-unit="–º¬≤" class="work-checkbox">
                                <span>–í—ã–±—Ä–∞—Ç—å</span>
                            </label>
                        </div>

                        <div class="work-details" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º¬≤)</label>
                                    <input type="number" min="1" max="1000" step="1"
                                           class="work-quantity"
                                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;"
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 50">
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #666; font-size: 0.9rem;">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                                    <div class="work-cost" style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">0 ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –†–∞–±–æ—Ç–∞ 2 -->
                    <div class="work-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h4 style="color: #2c3e50; margin: 0; font-size: 1.1rem;">–≠–ª–µ–∫—Ç—Ä–æ–º–æ–Ω—Ç–∞–∂–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h4>
                                <p style="color: #666; margin: 5px 0; font-size: 0.9rem;">–ü—Ä–æ–∫–ª–∞–¥–∫–∞ –ø—Ä–æ–≤–æ–¥–∫–∏, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ–∑–µ—Ç–æ–∫</p>
                                <p style="color: #e74c3c; font-weight: 600; margin: 0;">1 500 ‚ÇΩ –∑–∞ —Ç–æ—á–∫—É</p>
                            </div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="work_type" value="–≠–ª–µ–∫—Ç—Ä–æ–º–æ–Ω—Ç–∞–∂–Ω—ã–µ —Ä–∞–±–æ—Ç—ã" data-price="1500" data-unit="—Ç–æ—á–∫–∞" class="work-checkbox">
                                <span>–í—ã–±—Ä–∞—Ç—å</span>
                            </label>
                        </div>

                        <div class="work-details" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫</label>
                                    <input type="number" min="1" max="100" step="1"
                                           class="work-quantity"
                                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;"
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10">
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #666; font-size: 0.9rem;">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                                    <div class="work-cost" style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">0 ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –†–∞–±–æ—Ç–∞ 3 -->
                    <div class="work-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h4 style="color: #2c3e50; margin: 0; font-size: 1.1rem;">–°–∞–Ω—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã</h4>
                                <p style="color: #666; margin: 5px 0; font-size: 0.9rem;">–£—Å—Ç–∞–Ω–æ–≤–∫–∞/–∑–∞–º–µ–Ω–∞ —Å–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∏</p>
                                <p style="color: #e74c3c; font-weight: 600; margin: 0;">4 000 ‚ÇΩ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</p>
                            </div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="work_type" value="–°–∞–Ω—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã" data-price="4000" data-unit="–µ–¥–∏–Ω–∏—Ü–∞" class="work-checkbox">
                                <span>–í—ã–±—Ä–∞—Ç—å</span>
                            </label>
                        </div>

                        <div class="work-details" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü</label>
                                    <input type="number" min="1" max="50" step="1"
                                           class="work-quantity"
                                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;"
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5">
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #666; font-size: 0.9rem;">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                                    <div class="work-cost" style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">0 ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –†–∞–±–æ—Ç–∞ 4 -->
                    <div class="work-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h4 style="color: #2c3e50; margin: 0; font-size: 1.1rem;">–ú–∞–ª—è—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h4>
                                <p style="color: #666; margin: 5px 0; font-size: 0.9rem;">–ü–æ–∫—Ä–∞—Å–∫–∞ —Å—Ç–µ–Ω, –ø–æ—Ç–æ–ª–∫–æ–≤</p>
                                <p style="color: #e74c3c; font-weight: 600; margin: 0;">800 ‚ÇΩ –∑–∞ –º¬≤</p>
                            </div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="work_type" value="–ú–∞–ª—è—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã" data-price="800" data-unit="–º¬≤" class="work-checkbox">
                                <span>–í—ã–±—Ä–∞—Ç—å</span>
                            </label>
                        </div>

                        <div class="work-details" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º¬≤)</label>
                                    <input type="number" min="1" max="500" step="1"
                                           class="work-quantity"
                                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;"
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100">
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #666; font-size: 0.9rem;">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                                    <div class="work-cost" style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">0 ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –†–∞–±–æ—Ç–∞ 5 -->
                    <div class="work-item" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <h4 style="color: #2c3e50; margin: 0; font-size: 1.1rem;">–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–≤–µ—Ä–µ–π/–æ–∫–æ–Ω</h4>
                                <p style="color: #666; margin: 5px 0; font-size: 0.9rem;">–ú–æ–Ω—Ç–∞–∂ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞</p>
                                <p style="color: #e74c3c; font-weight: 600; margin: 0;">2 500 ‚ÇΩ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É</p>
                            </div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" name="work_type" value="–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–≤–µ—Ä–µ–π/–æ–∫–æ–Ω" data-price="2500" data-unit="–µ–¥–∏–Ω–∏—Ü–∞" class="work-checkbox">
                                <span>–í—ã–±—Ä–∞—Ç—å</span>
                            </label>
                        </div>

                        <div class="work-details" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: center;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 0.9rem;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü</label>
                                    <input type="number" min="1" max="20" step="1"
                                           class="work-quantity"
                                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;"
                                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3">
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #666; font-size: 0.9rem;">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                                    <div class="work-cost" style="font-size: 1.2rem; font-weight: 600; color: #2c3e50;">0 ‚ÇΩ</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–±–æ—Ç–∞—Ö -->
                <input type="hidden" id="selected_works_json" name="selected_works_json">
                <input type="hidden" id="total_amount" name="total_amount">

                <!-- –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç -->
                <div id="totalCalculation" style="display: none; background: #e8f4fc; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1rem;">üìä –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç</h4>

                    <div id="worksSummary" style="margin-bottom: 15px;">
                        <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç -->
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #ccc;">
                        <div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: #2c3e50;">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                            <div style="font-size: 0.9rem; color: #666;">–ë–µ–∑ —É—á–µ—Ç–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –¥–æ–ø. —É—Å–ª—É–≥</div>
                        </div>
                        <div id="finalTotal" style="font-size: 1.8rem; font-weight: 700; color: #e74c3c;">0 ‚ÇΩ</div>
                    </div>
                </div>

                <div id="noWorksError" style="color: #e74c3c; margin-top: 10px; display: none;">
                    ‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∏–¥ —Ä–∞–±–æ—Ç
                </div>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div style="margin-bottom: 25px;">
                <label for="comment" style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞—è–≤–∫–µ
                </label>
                <textarea id="comment" name="comment" rows="4"
                          placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞, —Å—Ä–æ–∫–∏..."
                          style="width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; resize: vertical; min-height: 120px;"></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary" style="font-size: 1.1rem; padding: 14px 40px;" id="submitBtn">
                    üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É —Å —Ä–∞—Å—á–µ—Ç–æ–º
                </button>
            </div>
        </form>

        <div style="font-size: 0.9rem; color: #666; text-align: center; padding-top: 20px; border-top: 1px solid #eee;">
            <p>–ü–æ–ª—è, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ * - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</p>
            <p style="margin-top: 10px;">‚ö†Ô∏è –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º</p>
        </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; margin-top: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 15px;">üìû –ù—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è?</h3>
        <p style="margin-bottom: 10px;">–ó–≤–æ–Ω–∏—Ç–µ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞:</p>
        <p style="margin-bottom: 15px;">
            <a href="tel:+79991234567" style="color: #e74c3c; text-decoration: none; font-size: 1.2rem; font-weight: 600;">
                +7 (999) 123-45-67
            </a>
        </p>
        <p style="font-size: 0.9rem; color: #666;">
            –ù–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–µ—Ç –≤–∞—Å –∏ —Å–¥–µ–ª–∞–µ—Ç —Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç
        </p>
    </div>
</div>

<!-- JavaScript –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const workCheckboxes = document.querySelectorAll('.work-checkbox');
    const applicationForm = document.getElementById('applicationForm');
    const totalCalculation = document.getElementById('totalCalculation');
    const worksSummary = document.getElementById('worksSummary');
    const finalTotal = document.getElementById('finalTotal');
    const noWorksError = document.getElementById('noWorksError');
    const selectedWorksInput = document.getElementById('selected_works_json');
    const totalAmountInput = document.getElementById('total_amount');
    const submitBtn = document.getElementById('submitBtn');

    // –î–∞–Ω–Ω—ã–µ –æ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞—Ö
    let selectedWorks = [];
    let totalAmount = 0;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞
    workCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const workItem = this.closest('.work-item');
            const workDetails = workItem.querySelector('.work-details');
            const quantityInput = workItem.querySelector('.work-quantity');
            const costDisplay = workItem.querySelector('.work-cost');

            if (this.checked) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
                workDetails.style.display = 'block';
                quantityInput.required = true;
                quantityInput.value = 1;

                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–±–æ—Ç—É –≤ —Å–ø–∏—Å–æ–∫
                const workData = {
                    type: this.value,
                    price: parseFloat(this.dataset.price),
                    unit: this.dataset.unit,
                    quantity: 1,
                    cost: parseFloat(this.dataset.price)
                };

                selectedWorks.push(workData);
                calculateWork(workItem, workData);

            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
                workDetails.style.display = 'none';
                quantityInput.required = false;
                quantityInput.value = '';
                costDisplay.textContent = '0 ‚ÇΩ';

                // –£–¥–∞–ª—è–µ–º —Ä–∞–±–æ—Ç—É –∏–∑ —Å–ø–∏—Å–∫–∞
                selectedWorks = selectedWorks.filter(work => work.type !== this.value);
            }

            updateTotalCalculation();
            validateForm();
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    document.querySelectorAll('.work-quantity').forEach(input => {
        input.addEventListener('input', function() {
            const workItem = this.closest('.work-item');
            const checkbox = workItem.querySelector('.work-checkbox');
            const costDisplay = workItem.querySelector('.work-cost');

            if (checkbox.checked) {
                const quantity = parseInt(this.value) || 0;
                if (quantity > 0) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã
                    const workIndex = selectedWorks.findIndex(work => work.type === checkbox.value);
                    if (workIndex !== -1) {
                        selectedWorks[workIndex].quantity = quantity;
                        selectedWorks[workIndex].cost = selectedWorks[workIndex].price * quantity;
                        calculateWork(workItem, selectedWorks[workIndex]);
                        updateTotalCalculation();
                    }
                }
            }
        });
    });

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–¥–Ω–æ–π —Ä–∞–±–æ—Ç—ã
    function calculateWork(workItem, workData) {
        const costDisplay = workItem.querySelector('.work-cost');
        const cost = workData.price * workData.quantity;
        costDisplay.textContent = cost.toLocaleString('ru-RU') + ' ‚ÇΩ';
        workData.cost = cost;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
    function updateTotalCalculation() {
        // –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
        totalAmount = selectedWorks.reduce((sum, work) => sum + work.cost, 0);

        if (selectedWorks.length > 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–∞—Å—á–µ—Ç–∞
            totalCalculation.style.display = 'block';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç
            worksSummary.innerHTML = '';
            selectedWorks.forEach(work => {
                const workElement = document.createElement('div');
                workElement.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #ddd;';
                workElement.innerHTML = `
                    <span>${work.type} (${work.quantity} ${work.unit})</span>
                    <span style="font-weight: 600;">${work.cost.toLocaleString('ru-RU')} ‚ÇΩ</span>
                `;
                worksSummary.appendChild(workElement);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
            finalTotal.textContent = totalAmount.toLocaleString('ru-RU') + ' ‚ÇΩ';

        } else {
            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–∞—Å—á–µ—Ç–∞
            totalCalculation.style.display = 'none';
            finalTotal.textContent = '0 ‚ÇΩ';
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        selectedWorksInput.value = JSON.stringify(selectedWorks);
        totalAmountInput.value = totalAmount;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    function validateForm() {
        const hasSelectedWorks = selectedWorks.length > 0;
        const allQuantitiesValid = selectedWorks.every(work => work.quantity > 0);

        if (!hasSelectedWorks) {
            noWorksError.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
            return false;
        } else if (!allQuantitiesValid) {
            noWorksError.style.display = 'block';
            noWorksError.textContent = '‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç';
            submitBtn.disabled = true;
            submitBtn.style.opacity = '0.6';
            return false;
        } else {
            noWorksError.style.display = 'none';
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            return true;
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    applicationForm.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥—ã —Ä–∞–±–æ—Ç –∏ —É–∫–∞–∂–∏—Ç–µ –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
            return false;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (!confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞—è–≤–∫–∏ –Ω–∞ —Å—É–º–º—É ${totalAmount.toLocaleString('ru-RU')} ‚ÇΩ`)) {
            e.preventDefault();
            return false;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–∞—Å—á–µ—Ç–µ –≤ —Ñ–æ—Ä–º—É
        const formData = new FormData(this);

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–±–æ—Ç–∞—Ö –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
        const worksText = selectedWorks.map(work =>
            `${work.type}: ${work.quantity} ${work.unit} √ó ${work.price} ‚ÇΩ = ${work.cost} ‚ÇΩ`
        ).join('\n');

        const worksField = document.createElement('textarea');
        worksField.name = 'works_description';
        worksField.style.display = 'none';
        worksField.textContent = '–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:\n' + worksText + '\n\n–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ' + totalAmount.toLocaleString('ru-RU') + ' ‚ÇΩ';
        this.appendChild(worksField);

        return true;
    });

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    validateForm();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tooltips
    document.querySelectorAll('.work-checkbox').forEach(checkbox => {
        checkbox.addEventListener('mouseenter', function() {
            const workItem = this.closest('.work-item');
            workItem.style.boxShadow = '0 0 0 2px #3498db';
        });

        checkbox.addEventListener('mouseleave', function() {
            const workItem = this.closest('.work-item');
            workItem.style.boxShadow = '';
        });
    });
});
</script>

<style>
    @media (max-width: 768px) {
        .work-item {
            padding: 12px !important;
        }

        .work-item > div:first-child {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 10px !important;
        }

        label[style*="display: flex"] {
            width: 100%;
            justify-content: space-between;
        }

        .work-details > div {
            grid-template-columns: 1fr !important;
            gap: 10px !important;
        }

        #finalTotal {
            font-size: 1.5rem !important;
        }

        .btn-primary {
            width: 100%;
            max-width: 300px;
            padding: 12px 20px !important;
        }
    }

    input:focus, textarea:focus {
        outline: none;
        border-color: #3498db !important;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .work-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .work-quantity {
        transition: all 0.3s;
    }

    .work-quantity:focus {
        border-color: #2c3e50 !important;
    }
</style>
{% endblock %}